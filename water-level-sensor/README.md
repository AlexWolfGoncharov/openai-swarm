# WaterSense ‚Äî –¥–∞—Ç—á–∏–∫ —É—Ä–æ–≤–Ω—è –≤–æ–¥—ã (ESP8266 / Wemos D1 mini)

–£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ —É—Ä–æ–≤–Ω—è –≤–æ–¥—ã –≤ –±–æ—á–∫–µ –Ω–∞ –±–∞–∑–µ `Wemos D1 mini (ESP8266)` + `HC-SR04` + `DS18B20`.

README –Ω–∏–∂–µ –Ω–∞–ø–∏—Å–∞–Ω –∫–∞–∫ **–ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–π runbook**: —á—Ç–æ–±—ã –ª—é–±–æ–π –¥—Ä—É–≥–æ–π –∞–≥–µ–Ω—Ç/–∏–Ω–∂–µ–Ω–µ—Ä –º–æ–≥ –±—ã—Å—Ç—Ä–æ –ø–æ–Ω—è—Ç—å, –∫–∞–∫ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ —É—Å—Ç—Ä–æ–µ–Ω–æ, –∫–∞–∫ –µ–≥–æ –ø—Ä–æ—à–∏–≤–∞—Ç—å, –∫–∞–∫ –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—Ç—å –∫–æ–Ω—Ñ–∏–≥ –∏ –∫–∞–∫–∏–µ –∫–æ–º–∞–Ω–¥—ã/–Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–æ—Å—Ç—É–ø–Ω—ã.

## –ß—Ç–æ —É–º–µ–µ—Ç —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ

- –ò–∑–º–µ—Ä–µ–Ω–∏–µ —É—Ä–æ–≤–Ω—è –≤–æ–¥—ã (`HC-SR04`) —Å –º–µ–¥–∏–∞–Ω–Ω—ã–º —Ñ–∏–ª—å—Ç—Ä–æ–º + EMA-—Å–≥–ª–∞–∂–∏–≤–∞–Ω–∏–µ–º
- –†–∞—Å—á—ë—Ç –æ–±—ä—ë–º–∞/—Å–≤–æ–±–æ–¥–Ω–æ–≥–æ –æ–±—ä—ë–º–∞ –≤ –ª–∏—Ç—Ä–∞—Ö (–ø–æ –¥–∏–∞–º–µ—Ç—Ä—É –±–æ—á–∫–∏)
- –¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ –≤–æ–¥—ã/–æ–∫—Ä—É–∂–µ–Ω–∏—è (`DS18B20`)
- –í–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å (–¥–∞—à–±–æ—Ä–¥ + –Ω–∞—Å—Ç—Ä–æ–π–∫–∏)
- –ò—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ—Ä–µ–Ω–∏–π –≤ `LittleFS` (–ø–æ—á–∞—Å–æ–≤—ã–µ —Å–Ω–∏–º–∫–∏)
- MQTT (–æ—Ç–¥–µ–ª—å–Ω—ã–µ —Ç–æ–ø–∏–∫–∏ + JSON + Home Assistant discovery)
- Telegram-–±–æ—Ç (–∫–æ–º–∞–Ω–¥—ã, —Å—Ç–∞—Ä—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ, –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ –∞–ª–µ—Ä—Ç—ã)
- OTA (ArduinoOTA + –≤–µ–± `/update`)
- AP-—Ä–µ–∂–∏–º –¥–ª—è –ø–µ—Ä–≤–∏—á–Ω–æ–π –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
- Web debug mode (`/api/logs`) —Å –∑–µ—Ä–∫–∞–ª–æ–º serial-–ª–æ–≥–æ–≤

## –ê–∫—Ç—É–∞–ª—å–Ω–∞—è –ª–æ–≥–∏–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏

- –•—Ä–∞–Ω–µ–Ω–∏–µ –≤ `LittleFS` (—Ñ–∞–π–ª `hist.bin`)
- –§–æ—Ä–º–∞—Ç: –∫–æ–ª—å—Ü–µ–≤–æ–π –±—É—Ñ–µ—Ä —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ —Ä–∞–∑–º–µ—Ä–∞
- –ü–µ—Ä–∏–æ–¥ –∑–∞–ø–∏—Å–∏: **1 —Ä–∞–∑ –≤ —á–∞—Å**
- –Å–º–∫–æ—Å—Ç—å: **2160 –∑–∞–ø–∏—Å–µ–π** (–ø—Ä–∏–º–µ—Ä–Ω–æ **90 –¥–Ω–µ–π**)
- –ì—Ä–∞—Ñ–∏–∫ –≤ –≤–µ–±–µ —Å–µ–π—á–∞—Å –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç –¥–æ **168 —á–∞—Å–æ–≤ (7 –¥–Ω–µ–π)**
- CSV-—ç–∫—Å–ø–æ—Ä—Ç –≤—ã–≥—Ä—É–∂–∞–µ—Ç –≤—Å—é –∏—Å—Ç–æ—Ä–∏—é (–¥–æ 2160 –∑–∞–ø–∏—Å–µ–π)

–í–∞–∂–Ω–æ:
- –ü—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Ñ–æ—Ä–º–∞—Ç–∞ –∏—Å—Ç–æ—Ä–∏–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, —Ä–∞–∑–º–µ—Ä –∑–∞–ø–∏—Å–∏ –∏–ª–∏ `MAX_REC`) —Ñ–∞–π–ª `hist.bin` –±—É–¥–µ—Ç –ø–µ—Ä–µ—Å–æ–∑–¥–∞–Ω.
- `uploadfs` –≤—Å–µ–≥–¥–∞ –ø–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç `LittleFS` –∏ —Å—Ç–∏—Ä–∞–µ—Ç –∏—Å—Ç–æ—Ä–∏—é.

## –í—Ä–µ–º—è –∏ —á–∞—Å–æ–≤–æ–π –ø–æ—è—Å

–£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ —Ä–∞–±–æ—Ç–∞–µ—Ç —Å NTP, –ª–æ–∫–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è –¥–ª—è –º–µ—Ç–æ–∫ –∏—Å—Ç–æ—Ä–∏–∏/Telegram –≤—ã—Å—Ç–∞–≤–ª—è–µ—Ç—Å—è –≤ **–ö–∏–µ–≤—Å–∫–æ–º —á–∞—Å–æ–≤–æ–º –ø–æ—è—Å–µ**:
- `Europe/Kyiv` (EET/EEST, —Å –ø–µ—Ä–µ—Ö–æ–¥–æ–º –Ω–∞ –ª–µ—Ç–Ω–µ–µ –≤—Ä–µ–º—è)

–≠—Ç–æ –≤–ª–∏—è–µ—Ç –Ω–∞:
- –ø–æ–¥–ø–∏—Å–∏ –≤—Ä–µ–º–µ–Ω–∏ –≤ –≥—Ä–∞—Ñ–∏–∫–∞—Ö (`/api/history`)
- –≤—Ä–µ–º—è –≤ Telegram —Å–æ–æ–±—â–µ–Ω–∏—è—Ö (`/status`, —Å—Ç–∞—Ä—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –∏ —Ç.–ø.)
- –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –≤ –≤–µ–±–µ (UI –ø–æ–¥–ø–∏—Å–∞–Ω –∫–∞–∫ ¬´–û–±–Ω–æ–≤–ª–µ–Ω–æ (–ö–∏–µ–≤)¬ª)

## –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –¥–∞—Ç—á–∏–∫–æ–≤ (–±–∞–∑–æ–≤–∞—è —Å—Ö–µ–º–∞)

### HC-SR04 (—É—Ä–æ–≤–µ–Ω—å)

```text
Wemos D1 Mini    HC-SR04
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ    ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
5V          ‚îÄ‚îÄ‚ñ∂  VCC
GND         ‚îÄ‚îÄ‚ñ∂  GND
D5 (GPIO14) ‚îÄ‚îÄ‚ñ∂  TRIG
D6 (GPIO12) ‚îÄ‚îÄ‚ñ∂  ECHO
```

### DS18B20 (—Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞)

```text
Wemos D1 Mini    DS18B20
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ    ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
3V3         ‚îÄ‚îÄ‚ñ∂  VCC
GND         ‚îÄ‚îÄ‚ñ∂  GND
D4 (GPIO2)  ‚îÄ‚îÄ‚ñ∂  DATA
```

–û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ:
- –ø–æ–¥—Ç—è–≥–∏–≤–∞—é—â–∏–π —Ä–µ–∑–∏—Å—Ç–æ—Ä `4.7 –∫–û–º` –º–µ–∂–¥—É `DATA` –∏ `3.3V`

### –í–∞–∂–Ω—ã–µ —ç–ª–µ–∫—Ç—Ä–∏—á–µ—Å–∫–∏–µ –∑–∞–º–µ—á–∞–Ω–∏—è

- `HC-SR04 ECHO` –≤—ã–¥–∞—ë—Ç `5V` -> **–Ω—É–∂–µ–Ω –¥–µ–ª–∏—Ç–µ–ª—å** –¥–æ `3.3V` –Ω–∞ –≤—Ö–æ–¥ ESP8266
- –ù—É–∂–Ω–∞ –æ–±—â–∞—è –∑–µ–º–ª—è (`GND`) –º–µ–∂–¥—É Wemos –∏ –¥–∞—Ç—á–∏–∫–∞–º–∏
- –î–ª—è —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏ –ø–∏—Ç–∞–Ω–∏—è –ø–æ–ª–µ–∑–µ–Ω –∫–æ–Ω–¥–µ–Ω—Å–∞—Ç–æ—Ä `470‚Äì1000 ¬µF` –º–µ–∂–¥—É `5V` –∏ `GND` —Ä—è–¥–æ–º —Å –ø–ª–∞—Ç–æ–π

## –í–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ —Ä–µ–ª–∏–∑—ã

### –ü—Ä–∏–Ω—Ü–∏–ø

–í–µ—Ä—Å–∏—è –ø—Ä–æ—à–∏–≤–∫–∏ –±–µ—Ä—ë—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏–∑ **git-—Ç–µ–≥–∞** –ø—Ä–∏ —Å–±–æ—Ä–∫–µ —á–µ—Ä–µ–∑ PlatformIO.
–¢–µ–≥–∏ –∏—Å–ø–æ–ª—å–∑—É—é—Ç [Semantic Versioning](https://semver.org/): `vMAJOR.MINOR.PATCH`.

| –í–∏–¥ –∏–∑–º–µ–Ω–µ–Ω–∏—è | –ß—Ç–æ –±–∞–º–ø–∞—Ç—å | –ü—Ä–∏–º–µ—Ä |
|---|---|---|
| –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –±–∞–≥–∞ / –Ω–µ–±–æ–ª—å—à–æ–π –ø–∞—Ä–∞–º–µ—Ç—Ä | `PATCH` | `v1.0.1 ‚Üí v1.0.2` |
| –ù–æ–≤–∞—è —Ñ–∏—á–∞, —Å–æ–≤–º–µ—Å—Ç–∏–º—ã–π API | `MINOR` | `v1.0.2 ‚Üí v1.1.0` |
| –õ–æ–º–∞—é—â–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∫–æ–Ω—Ñ–∏–≥–∞/—Ö—Ä–∞–Ω–∏–ª–∏—â–∞ | `MAJOR` | `v1.1.0 ‚Üí v2.0.0` |

> **–ü—Ä–∞–≤–∏–ª–æ:** –∫–æ–º–º–∏—Ç –±–µ–∑ —Ç–µ–≥–∞ ‚Äî —ç—Ç–æ –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω–∞—è —Ä–∞–±–æ—Ç–∞, –≤–µ—Ä—Å–∏—è = `dev`.
> –¢–µ–≥ ‚Äî —ç—Ç–æ —Ä–µ–ª–∏–∑, CI –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–±–∏—Ä–∞–µ—Ç –ø—Ä–æ—à–∏–≤–∫—É –∏ –ø—É–±–ª–∏–∫—É–µ—Ç –≤ GitHub Releases.

---

### –†–∞–±–æ—á–∏–π –ø—Ä–æ—Ü–µ—Å—Å (—à–∞–≥ –∑–∞ —à–∞–≥–æ–º)

#### –û–±—ã—á–Ω—ã–π –∫–æ–º–º–∏—Ç (—Ä–∞–±–æ—Ç–∞ –≤ feature-–≤–µ—Ç–∫–µ)

–ü—Ä–æ—Å—Ç–æ –∫–æ–º–º–∏—Ç—å –∏ –ø—É—à—å ‚Äî –±–µ–∑ —Ç–µ–≥–æ–≤. –í–µ—Ä—Å–∏—è –±—É–¥–µ—Ç `dev`, CI —Ç–æ–ª—å–∫–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç –∫–æ–º–ø–∏–ª—è—Ü–∏—é.

```bash
git add .
git commit -m "fix: –æ–ø–∏—Å–∞–Ω–∏–µ —á—Ç–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ"
git push origin <–≤–µ—Ç–∫–∞>
```

#### –ú—ë—Ä–¥–∂ –≤ main

1. –°–æ–∑–¥–∞–π Pull Request –∏–∑ —Å–≤–æ–µ–π –≤–µ—Ç–∫–∏ ‚Üí `main`
2. –ó–∞–º—ë—Ä–¥–∂ ‚Äî CI —Å–Ω–æ–≤–∞ –ø—Ä–æ–≥–æ–Ω–∏—Ç –∫–æ–º–ø–∏–ª—è—Ü–∏—é
3. **–í–µ—Ä—Å–∏—é –ø–æ–∫–∞ –Ω–µ —Å–æ–∑–¥–∞–≤–∞–π**, –µ—Å–ª–∏ —ç—Ç–æ –Ω–µ –≥–æ—Ç–æ–≤—ã–π —Ä–µ–ª–∏–∑

#### –°–æ–∑–¥–∞–Ω–∏–µ —Ä–µ–ª–∏–∑–∞ (–≤—ã–ø—É—Å–∫ –Ω–æ–≤–æ–π –≤–µ—Ä—Å–∏–∏)

–¢–æ–ª—å–∫–æ –∫–æ–≥–¥–∞ `main` —Å—Ç–∞–±–∏–ª–µ–Ω –∏ –≥–æ—Ç–æ–≤ –∫ –∑–∞–ª–∏–≤–∫–µ –Ω–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ:

```bash
# —É–±–µ–¥–∏—Å—å —á—Ç–æ —Ç—ã –Ω–∞ main –∏ –æ–Ω –∞–∫—Ç—É–∞–ª–µ–Ω
git checkout main && git pull origin main

# –ø–æ—Å—Ç–∞–≤—å —Ç–µ–≥ (–∑–∞–º–µ–Ω–∏ –≤–µ—Ä—Å–∏—é –Ω–∞ –Ω—É–∂–Ω—É—é)
git tag v1.2.3
git push origin v1.2.3
```

–ü–æ—Å–ª–µ –ø—É—à–∞ —Ç–µ–≥–∞ GitHub Actions –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏:
1. –°–æ–±–µ—Ä—ë—Ç –ø—Ä–æ—à–∏–≤–∫—É —á–µ—Ä–µ–∑ PlatformIO (`pio run`)
2. –°–æ–∑–¥–∞—Å—Ç **GitHub Release** —Å –ø—Ä–∏–∫—Ä–µ–ø–ª—ë–Ω–Ω—ã–º `firmware.bin`
3. –û–±–Ω–æ–≤–∏—Ç —Ñ–∞–π–ª `firmware/version.json` –≤ main

–£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ —Å –≤–∫–ª—é—á—ë–Ω–Ω—ã–º auto-OTA —Å–∞–º–æ —Å–∫–∞—á–∞–µ—Ç –∏ –ø—Ä–æ—à—å—ë—Ç—Å—è –≤ —Ç–µ—á–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–Ω–æ–≥–æ –∏–Ω—Ç–µ—Ä–≤–∞–ª–∞.

---

### –ß—Ç–æ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç CI –Ω–∞ –∫–∞–∂–¥—ã–π –∫–æ–º–º–∏—Ç/PR

- –§–∞–π–ª: `.github/workflows/firmware-ci.yml`
- –ö–æ–º–ø–∏–ª—è—Ü–∏—è —á–µ—Ä–µ–∑ `pio run` (–±–µ–∑ –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ)
- –ï—Å–ª–∏ –Ω–µ –∫–æ–º–ø–∏–ª–∏—Ä—É–µ—Ç—Å—è ‚Äî PR –Ω–µ–ª—å–∑—è —Å–º—ë—Ä–¥–∂–∏—Ç—å

---

### –ö–∞–∫ –ø–æ–¥–∫–ª—é—á–∏—Ç—å auto-OTA –Ω–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ

–ü–æ—Å–ª–µ –ø–µ—Ä–≤–æ–≥–æ —Ä–µ–ª–∏–∑–∞ (—Ç–µ–≥ `v1.x.x` –≤ GitHub):

```bash
# —á–µ—Ä–µ–∑ serial
cfg set ua true
cfg set uu https://raw.githubusercontent.com/AlexWolfGoncharov/openai-swarm/main/firmware/version.json
cfg set ui 6
cfg save
reboot
```

–ò–ª–∏ —á–µ—Ä–µ–∑ `POST /api/config`:
```json
{
  "ua": true,
  "uu": "https://raw.githubusercontent.com/AlexWolfGoncharov/openai-swarm/main/firmware/version.json",
  "ui": 6
}
```

---

## –°–±–æ—Ä–∫–∞ –∏ –ø—Ä–æ—à–∏–≤–∫–∞ (PlatformIO)

–ü—Ä–∏–º–µ—Ä —Ä–∞–±–æ—á–∏—Ö –∫–æ–º–∞–Ω–¥ (USB):

```bash
git clone https://github.com/AlexWolfGoncharov/openai-swarm.git
cd openai-swarm/water-level-sensor
platformio run -t upload --upload-port /dev/cu.usbserial-110
```

–§–∞–π–ª–æ–≤–∞—è —Å–∏—Å—Ç–µ–º–∞ (–≤–µ–± UI / `LittleFS`):

```bash
platformio run -t uploadfs --upload-port /dev/cu.usbserial-110
```

Serial monitor:

```bash
platformio device monitor --port /dev/cu.usbserial-110 --baud 115200
```

–í–∞–∂–Ω–æ:
- –ò–Ω–æ–≥–¥–∞ –ø–µ—Ä–µ–¥ `upload` –Ω—É–∂–Ω–æ –≤—Ä—É—á–Ω—É—é –ø–µ—Ä–µ–≤–µ—Å—Ç–∏ Wemos –≤ —Ä–µ–∂–∏–º –ø—Ä–æ—à–∏–≤–∫–∏.
- `uploadfs` **—Å—Ç–∏—Ä–∞–µ—Ç `LittleFS`**: –≤–µ–±-—Ñ–∞–π–ª—ã –æ–±–Ω–æ–≤—è—Ç—Å—è, –Ω–æ —Ç–∞–∫–∂–µ –±—É–¥—É—Ç –ø–æ—Ç–µ—Ä—è–Ω—ã:
  - `config.json`
  - `hist.bin`

## OTA –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ

–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è:
- ArduinoOTA (–∏–∑ PlatformIO / `espota`)
- –≤–µ–±-–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ `http://<ip>/update`

–ü–∞—Ä–æ–ª—å OTA —Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ –∫–æ–Ω—Ñ–∏–≥–µ (`op`).

## –ü–µ—Ä–≤—ã–π –∑–∞–ø—É—Å–∫ / AP-—Ä–µ–∂–∏–º

–ï—Å–ª–∏ Wi‚ÄëFi –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω –∏–ª–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω:
- —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –ø–æ–¥–Ω–∏–º–µ—Ç AP:
  - `SSID: WaterSensor-<chipid>`
  - –ø–∞—Ä–æ–ª—å: `watersensor`
- –æ—Ç–∫—Ä—ã—Ç—å `http://192.168.4.1`
- –ø–µ—Ä–µ–π—Ç–∏ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∏ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å Wi‚ÄëFi

## –í–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å

### –°—Ç—Ä–∞–Ω–∏—Ü—ã

- `/` ‚Äî –¥–∞—à–±–æ—Ä–¥
- `/set.html` ‚Äî –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
- `/update` ‚Äî –≤–µ–±-–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–æ—à–∏–≤–∫–∏

### –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ –¥–∞—à–±–æ—Ä–¥–∞

- –≥—Ä–∞—Ñ–∏–∫ —É—Ä–æ–≤–Ω—è (`24—á / 3 –¥–Ω—è / 7 –¥–Ω–µ–π`)
- –≥—Ä–∞—Ñ–∏–∫ —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—ã
- –ø–æ–¥–ø–∏—Å–∏ –≥—Ä–∞—Ñ–∏–∫–∞ —É—Ä–æ–≤–Ω—è –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç **–ø—Ä–æ—Ü–µ–Ω—Ç—ã –∏ –ª–∏—Ç—Ä—ã**
- –∫–Ω–æ–ø–∫–∞ `üêû –†–µ–∂–∏–º –æ—Ç–ª–∞–¥–∫–∏` –≤–∫–ª—é—á–∞–µ—Ç live-—á—Ç–µ–Ω–∏–µ `/api/logs`

## HTTP API (–æ—Å–Ω–æ–≤–Ω–æ–µ)

### `GET /api/status`
–¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞.

–ü—Ä–∏–º–µ—Ä –ø–æ–ª–µ–π:
- `level`, `distance`, `volume`, `free`, `total`, `temp`
- `ts` (UNIX timestamp)
- `ip`, `rssi`, `heap`
- `diameter`
- `records`, `records_max`
- `wifi`, `mqtt`, `tg`
- `version`

### `GET /api/info`
–°–∏—Å—Ç–µ–º–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è (flash/sketch/heap/uptime –∏ —Ç.–¥.)

### `GET /api/history?h=<hours>`
–ò—Å—Ç–æ—Ä–∏—è –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–∞.

–ü–æ–ª—è –æ—Ç–≤–µ—Ç–∞:
- `labels` ‚Äî –º–µ—Ç–∫–∏ –≤—Ä–µ–º–µ–Ω–∏ (—É–∂–µ –≤ –ª–æ–∫–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏ –ö–∏–µ–≤–∞)
- `values` ‚Äî —É—Ä–æ–≤–µ–Ω—å –≤ %
- `volumes` ‚Äî –æ–±—ä—ë–º –≤ –ª–∏—Ç—Ä–∞—Ö
- `temps` ‚Äî —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ (–º–æ–∂–µ—Ç –±—ã—Ç—å `null`)

–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è:
- —Å–µ–π—á–∞—Å API –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–∞ —Ä–µ–∂–µ—Ç `h` –¥–æ `168` —á–∞—Å–æ–≤ (7 –¥–Ω–µ–π)

### `POST /api/measure`
–ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω—ã–π –∑–∞–º–µ—Ä (–≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–≤–µ–∂–∏–π `/api/status`).

### `GET /api/config`
–ß—Ç–µ–Ω–∏–µ —Ç–µ–∫—É—â–µ–π –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏.

–í–∞–∂–Ω–æ:
- —Å–µ–∫—Ä–µ—Ç—ã –º–∞—Å–∫–∏—Ä—É—é—Ç—Å—è (`‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢`) –∏ –Ω–µ –≤–æ–∑–≤—Ä–∞—â–∞—é—Ç—Å—è –≤ —è–≤–Ω–æ–º –≤–∏–¥–µ

### `POST /api/config`
–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏.

–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:
- –ø—Ä–∏–Ω–∏–º–∞–µ—Ç JSON
- –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è
- —á–∏—Å–ª–æ–≤—ã–µ `null` –∑–Ω–∞—á–µ–Ω–∏—è –∏–≥–Ω–æ—Ä–∏—Ä—É—é—Ç—Å—è (—á—Ç–æ–±—ã –Ω–µ –∑–∞—Ç–∏—Ä–∞—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –Ω—É–ª—è–º–∏)
- –µ—Å–ª–∏ –≤ –ø–æ–ª–µ —Å–µ–∫—Ä–µ—Ç–∞ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å `‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢`, —Å—Ç–∞—Ä–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è

### `GET /api/wifi-scan`
–°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ Wi‚ÄëFi —Å–µ—Ç–µ–π (SSID, RSSI, encrypted)

### `GET /api/logs`
–ö–æ–ª—å—Ü–µ–≤–æ–π –±—É—Ñ–µ—Ä –ª–æ–≥–æ–≤ (–∑–µ—Ä–∫–∞–ª–æ serial-–ª–æ–≥–∞ –≤ RAM)

### `GET /api/export`
CSV-—ç–∫—Å–ø–æ—Ä—Ç –∏—Å—Ç–æ—Ä–∏–∏ (–≤—Å—è –∏—Å—Ç–æ—Ä–∏—è –¥–æ 2160 –∑–∞–ø–∏—Å–µ–π)

### `DELETE /api/history`
–û—á–∏—Å—Ç–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é (`hist.bin`)

### `POST /api/reset`
–°–±—Ä–æ—Å –Ω–∞—Å—Ç—Ä–æ–µ–∫ + –æ—á–∏—Å—Ç–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏ + –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞

## –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è (`config.json`) –∏ –∫–ª—é—á–∏

–ö–æ–Ω—Ñ–∏–≥ —Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ `LittleFS` –≤ —Ñ–∞–π–ª–µ:
- `/config.json`

### –ü–æ–ª–Ω—ã–π —Å–ø–∏—Å–æ–∫ –∫–ª—é—á–µ–π (`/api/config`)

#### Wi‚ÄëFi
- `ws` ‚Äî SSID
- `wp` ‚Äî –ø–∞—Ä–æ–ª—å Wi‚ÄëFi

#### HC-SR04 / –∫–∞–ª–∏–±—Ä–æ–≤–∫–∞
- `tp` ‚Äî GPIO `TRIG`
- `ep` ‚Äî GPIO `ECHO`
- `ed` ‚Äî —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ –¥–æ –¥–Ω–∞ (empty distance), —Å–º
- `fd` ‚Äî —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ –¥–æ –≤–æ–¥—ã –ø—Ä–∏ –ø–æ–ª–Ω–æ–π –±–æ—á–∫–µ (full distance), —Å–º
- `bd` ‚Äî –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π –¥–∏–∞–º–µ—Ç—Ä –±–æ—á–∫–∏, —Å–º
- `as` ‚Äî —á–∏—Å–ª–æ –∑–∞–º–µ—Ä–æ–≤ –º–µ–¥–∏–∞–Ω–Ω–æ–≥–æ —Ñ–∏–ª—å—Ç—Ä–∞ (`1..30`); –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é `20`
- `ea` ‚Äî –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç EMA –º–µ–∂–¥—É —Ü–∏–∫–ª–∞–º–∏ (`0.01..1.0`); –º–µ–Ω—å—à–µ = –ø–ª–∞–≤–Ω–µ–µ; –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é `0.2`
- `ms` ‚Äî –∏–Ω—Ç–µ—Ä–≤–∞–ª –∏–∑–º–µ—Ä–µ–Ω–∏–π, —Å–µ–∫—É–Ω–¥—ã

#### MQTT
- `me` ‚Äî –≤–∫–ª—é—á–∏—Ç—å MQTT
- `mh` ‚Äî —Ö–æ—Å—Ç/IP –±—Ä–æ–∫–µ—Ä–∞
- `mp` ‚Äî –ø–æ—Ä—Ç
- `mu` ‚Äî –ª–æ–≥–∏–Ω
- `mq` ‚Äî –ø–∞—Ä–æ–ª—å
- `mt` ‚Äî –±–∞–∑–æ–≤—ã–π —Ç–æ–ø–∏–∫

#### Telegram
- `te` ‚Äî –≤–∫–ª—é—á–∏—Ç—å Telegram –º–æ–¥—É–ª—å
- `tt` ‚Äî —Ç–æ–∫–µ–Ω –±–æ—Ç–∞
- `tc` ‚Äî chat id
- `tx` ‚Äî –≤–∫–ª—é—á–∏—Ç—å polling –∫–æ–º–∞–Ω–¥ –±–æ—Ç–∞ (`/status`, `/measure`, ...)
- `tal` ‚Äî –∞–ª–µ—Ä—Ç –º–∏–Ω–∏–º—É–º (–º–∞–ª–æ –≤–æ–¥—ã)
- `tah` ‚Äî –∞–ª–µ—Ä—Ç –º–∞–∫—Å–∏–º—É–º (–º–Ω–æ–≥–æ –≤–æ–¥—ã)
- `tb` ‚Äî —Å—Ç–∞—Ä—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏
- `tl` ‚Äî –ø–æ—Ä–æ–≥ –º–∏–Ω–∏–º—É–º–∞ (%)
- `th` ‚Äî –ø–æ—Ä–æ–≥ –º–∞–∫—Å–∏–º—É–º–∞ (%)
- `td` ‚Äî –µ–∂–µ–¥–Ω–µ–≤–Ω—ã–π –æ—Ç—á—ë—Ç –≤ –ø–æ–ª–Ω–æ—á—å

#### DS18B20
- `de` ‚Äî –≤–∫–ª—é—á–∏—Ç—å –¥–∞—Ç—á–∏–∫ —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—ã
- `dp` ‚Äî GPIO –ø–∏–Ω–∞ –¥–∞–Ω–Ω—ã—Ö DS18B20

#### Auto-OTA (–∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–æ—à–∏–≤–∫–∏)
- `ua` ‚Äî –≤–∫–ª—é—á–∏—Ç—å –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫—É—é –ø—Ä–æ–≤–µ—Ä–∫—É –Ω–æ–≤–æ–π –ø—Ä–æ—à–∏–≤–∫–∏
- `uu` ‚Äî URL –∫ `version.json` (–æ–±—ã—á–Ω–æ raw GitHub URL)
- `ui` ‚Äî –∏–Ω—Ç–µ—Ä–≤–∞–ª –ø—Ä–æ–≤–µ—Ä–∫–∏, —á–∞—Å—ã (`1..24`); –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é `6`

#### –°–∏—Å—Ç–µ–º–∞
- `dn` ‚Äî –∏–º—è —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ (mDNS / OTA)
- `op` ‚Äî –ø–∞—Ä–æ–ª—å OTA

### –û–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å Telegram-–∞–ª–µ—Ä—Ç–æ–≤

–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è —Å—Ç–∞—Ä—ã–π –∫–ª—é—á:
- `ta` ‚Äî legacy alias, –≤–∫–ª—é—á–∞–µ—Ç/–≤—ã–∫–ª—é—á–∞–µ—Ç —Å—Ä–∞–∑—É –æ–±–∞ –∞–ª–µ—Ä—Ç–∞ (`tal` –∏ `tah`)

## Serial console (CLI)

–ü–æ—Å–ª–µ —Å—Ç–∞—Ä—Ç–∞ –≤ serial:
- `===== Water Level Sensor v1.0.0 =====`
- `[SER] Console ready. Type 'help'`

### –û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã

- `help`
- `cfg show`
- `cfg defaults`
- `cfg save`
- `cfg reload`
- `cfg raw` ‚Äî –≤—ã–≤–µ—Å—Ç–∏ **—Å—ã—Ä–æ–π** `config.json` (–≤–∫–ª—é—á–∞—è —Å–µ–∫—Ä–µ—Ç—ã; –æ—Å—Ç–æ—Ä–æ–∂–Ω–æ)
- `cfg set <key> <value>`
- `measure`
- `wifi scan`
- `reboot`

### `cfg set` ‚Äî –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ –∫–ª—é—á–∏ (serial aliases)

–°—Ç—Ä–æ–∫–∏:
- `ws`, `wp`
- `mh`, `mu`, `mq`, `mt`
- `tt`, `tc`
- `dn`, `op`

–ë—É–ª–µ–≤—ã:
- `me`, `te`, `tx`, `tal`, `tah`, `tb`, `td`, `de`
- `ta` ‚Äî legacy alias (—Å—Ç–∞–≤–∏—Ç –∏ `tal`, –∏ `tah`)

–¶–µ–ª—ã–µ:
- `tp`, `ep`, `dp`, `as`, `ms`, `mp`

Float:
- `ed`, `fd`, `bd`, `tl`, `th`

### –ü—Ä–∏–º–µ—Ä—ã serial-–∫–æ–º–∞–Ω–¥

```text
cfg show
cfg set tp 14
cfg set ep 12
cfg set dp 2
cfg set de true
cfg set ed 110
cfg set fd 25
cfg set bd 51
cfg set as 10
cfg set ms 60
cfg set me true
cfg set mh 192.168.4.107
cfg set mt watersensor
cfg set te true
cfg set tx true
cfg set tal false
cfg set tah false
cfg set tb true
cfg save
reboot
```

## Telegram: –∫–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç —Å–µ–π—á–∞—Å

### –ö–æ–º–∞–Ω–¥—ã –±–æ—Ç–∞

- `/level` –∏–ª–∏ `/—É—Ä–æ–≤–µ–Ω—å`
- `/status` –∏–ª–∏ `/—Å—Ç–∞—Ç—É—Å`
- `/measure` –∏–ª–∏ `/–∑–∞–º–µ—Ä` (—Ç–∞–∫–∂–µ `/update`, `/–æ–±–Ω–æ–≤–∏—Ç—å`)
- `/help` –∏–ª–∏ `/–ø–æ–º–æ—â—å`

### –õ–æ–≥–∏–∫–∞ Telegram-—Ñ–ª–∞–≥–æ–≤

- `te=false` -> Telegram –ø–æ–ª–Ω–æ—Å—Ç—å—é –≤—ã–∫–ª—é—á–µ–Ω
- `tx=false` -> –±–æ—Ç –Ω–µ –æ–ø—Ä–∞—à–∏–≤–∞–µ—Ç –≤—Ö–æ–¥—è—â–∏–µ –∫–æ–º–∞–Ω–¥—ã (polling –≤—ã–∫–ª—é—á–µ–Ω)
- `tal=false` -> –∞–ª–µ—Ä—Ç ¬´–º–∞–ª–æ –≤–æ–¥—ã¬ª –≤—ã–∫–ª—é—á–µ–Ω
- `tah=false` -> –∞–ª–µ—Ä—Ç ¬´–º–Ω–æ–≥–æ –≤–æ–¥—ã¬ª –≤—ã–∫–ª—é—á–µ–Ω
- `tb=true` -> –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è —Å—Ç–∞—Ä—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –¥–∞–Ω–Ω—ã–º–∏ –∏ IP
- `td=true` -> –µ–∂–µ–¥–Ω–µ–≤–Ω—ã–π –æ—Ç—á—ë—Ç –≤ –ø–æ–ª–Ω–æ—á—å

### –ó–∞—â–∏—Ç–∞ –æ—Ç —Å—Ç–∞—Ä—ã—Ö –∫–æ–º–∞–Ω–¥ (backlog sync)

–ü—Ä–∏ –ø–µ—Ä–≤–æ–º –æ–ø—Ä–æ—Å–µ Telegram –ø–æ—Å–ª–µ —Å—Ç–∞—Ä—Ç–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ—Ç `update_id` –∏ –ø—Ä–æ–ø—É—Å–∫–∞–µ—Ç –Ω–∞–∫–æ–ø–∏–≤—à–∏–µ—Å—è —Å—Ç–∞—Ä—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è, —á—Ç–æ–±—ã –Ω–µ –∏—Å–ø–æ–ª–Ω—è—Ç—å backlog –∫–æ–º–∞–Ω–¥ –ø–æ—Å–ª–µ –æ—Ñ—Ñ–ª–∞–π–Ω–∞.

## MQTT

### –ü—É–±–ª–∏–∫–∞—Ü–∏–∏ (–±–∞–∑–æ–≤—ã–π —Ç–æ–ø–∏–∫ `mt`, –Ω–∞–ø—Ä–∏–º–µ—Ä `watersensor`)

- `<mt>/level`
- `<mt>/distance`
- `<mt>/volume`
- `<mt>/free`
- `<mt>/temperature`
- `<mt>/json`

### Availability / LWT

- `watersensor/<chip_id>/status`
  - `online`
  - `offline`

### Home Assistant discovery

–ü—Ä–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏ MQTT —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –ø—É–±–ª–∏–∫—É–µ—Ç discovery –≤ `homeassistant/sensor/.../config`.

## –ó–Ω–∞—á–µ–Ω–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é (–≤ –∫–æ–¥–µ, –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ –ø–æ–¥ —Ç–µ–∫—É—â—É—é —É—Å—Ç–∞–Ω–æ–≤–∫—É)

–í–∞–∂–Ω–æ: —ç—Ç–æ **–¥–µ—Ñ–æ–ª—Ç—ã –ø—Ä–æ—à–∏–≤–∫–∏**, –∫–æ—Ç–æ—Ä—ã–µ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –ø—Ä–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏/—Å–±—Ä–æ—Å–µ `config.json`.
–¢–µ–∫—É—â–∞—è —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –º–æ–∂–µ—Ç –æ—Ç–ª–∏—á–∞—Ç—å—Å—è.

–ó–∞–¥–∞–Ω—ã –≤ `src/config.h`:
- Wi‚ÄëFi: `Katya_5G:)`
- Wi‚ÄëFi –ø–∞—Ä–æ–ª—å: `30101986`
- `tp=14`, `ep=12`
- `ed=110`, `fd=25`, `bd=51`
- `as=20`, `ea=0.2`, `ms=60`
- MQTT: `me=true`, `mh=192.168.4.107`, `mp=1883`, `mt=watersensor`
- Telegram:
  - `te=true`
  - `tx=true`
  - `tal=false`
  - `tah=false`
  - `tb=true`
  - `td=true`
  - `tc=125791364`
  - —Ç–æ–∫–µ–Ω (`tt`) **–Ω–µ –∑–∞—Ö–∞—Ä–¥–∫–æ–∂–µ–Ω** –≤ –¥–µ—Ñ–æ–ª—Ç—ã
- DS18B20: `de=true`, `dp=2` (D4)
- `dn=watersensor`
- `op=ota1234`

## –í–∞–∂–Ω–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ `uploadfs` (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –∫ –ø—Ä–æ—á—Ç–µ–Ω–∏—é)

`platformio run -t uploadfs` –ø–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç –≤–µ—Å—å —Ä–∞–∑–¥–µ–ª `LittleFS`.

–≠—Ç–æ —É–¥–∞–ª—è–µ—Ç:
- `config.json` (–≤—Å–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏, Wi‚ÄëFi, MQTT, Telegram token)
- `hist.bin` (–∏—Å—Ç–æ—Ä–∏—è)

### –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–π –ø–æ—Ä—è–¥–æ–∫ –¥–µ–π—Å—Ç–≤–∏–π –ø–µ—Ä–µ–¥ `uploadfs`

1. –ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –ø–æ serial
2. –í—ã–ø–æ–ª–Ω–∏—Ç—å `cfg raw`
3. –°–æ—Ö—Ä–∞–Ω–∏—Ç—å JSON –ª–æ–∫–∞–ª—å–Ω–æ (–≤ –Ω—ë–º –µ—Å—Ç—å —Å–µ–∫—Ä–µ—Ç—ã)
4. –í—ã–ø–æ–ª–Ω–∏—Ç—å `uploadfs`
5. –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∫–æ–Ω—Ñ–∏–≥ —á–µ—Ä–µ–∑ `cfg set ...` / `cfg save`
6. –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å –∏ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å `cfg show`

## Runbook –¥–ª—è –¥—Ä—É–≥–æ–≥–æ –∞–≥–µ–Ω—Ç–∞ (–µ—Å–ª–∏ –ø–æ–¥–∫–ª—é—á–∏–ª—Å—è –∫ –∂–∏–≤–æ–º—É –¥–∞—Ç—á–∏–∫—É)

### 1. –ù–∞–π—Ç–∏ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ

- –ø–æ IP —Ä–æ—É—Ç–µ—Ä–∞/DHCP
- –ø–æ mDNS: `http://watersensor.local` (–º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ—Å—Ç–∞–±–∏–ª—å–Ω–æ –Ω–∞ –Ω–µ–∫–æ—Ç–æ—Ä—ã—Ö Mac)
- –ø–æ MQTT retained status (`watersensor/<chip>/status`)

### 2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∂–∏–≤–æ—Å—Ç—å

```bash
curl -s http://<ip>/api/info
curl -s http://<ip>/api/status
curl -s 'http://<ip>/api/history?h=24'
```

### 3. –û—Ç–∫—Ä—ã—Ç—å serial (–µ—Å–ª–∏ –µ—Å—Ç—å USB)

```bash
platformio device monitor --port /dev/cu.usbserial-110 --baud 115200
```

–ü–æ–ª–µ–∑–Ω–æ —Å–º–æ—Ç—Ä–µ—Ç—å:
- `[CFG] loaded ...`
- `[WiFi] IP: ...`
- `[TG] ...`
- `[MQTT] ...`
- `[Sensor] ...`

### 4. –ü–µ—Ä–µ–¥ `uploadfs` —Å–Ω—è—Ç—å –∫–æ–Ω—Ñ–∏–≥ —Å —Å–µ–∫—Ä–µ—Ç–∞–º–∏

```text
cfg raw
```

### 5. –ü–æ—Å–ª–µ –ø—Ä–æ—à–∏–≤–∫–∏/`uploadfs` –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∫–æ–Ω—Ñ–∏–≥

- serial-–∫–æ–º–∞–Ω–¥–∞–º–∏ `cfg set ...`
- `cfg save`
- `reboot`

### 6. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∏—Ç–æ–≥

- `/api/config`
- `/api/status`
- `/api/logs`
- MQTT `online`
- Telegram (—Å—Ç–∞—Ä—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ / `/status` / `/measure`)

## –û—Ç–ª–∞–¥–∫–∞ –∏ —á–∞—Å—Ç—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

### –í–µ–± –Ω–µ –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è, –Ω–æ –ø–∏—Ç–∞–Ω–∏–µ –µ—Å—Ç—å

–ü—Ä–æ–≤–µ—Ä—å:
- IP –º–æ–≥ –∏–∑–º–µ–Ω–∏—Ç—å—Å—è (DHCP)
- `mDNS` –º–æ–∂–µ—Ç –Ω–µ —Ä–µ–∑–æ–ª–≤–∏—Ç—å—Å—è –Ω–∞ Mac
- serial-–ª–æ–≥ –Ω–∞ –Ω–∞–ª–∏—á–∏–µ reboot/panic

### –£–ª—å—Ç—Ä–∞–∑–≤—É–∫ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç `dist=-1`

–ü—Ä–æ–≤–µ—Ä—å:
- –ø—Ä–æ–≤–æ–¥–∫—É `TRIG/ECHO`
- –¥–µ–ª–∏—Ç–µ–ª—å –Ω–∞ `ECHO`
- `avg_samples` –Ω–µ —Ä–∞–≤–µ–Ω `0`
- –≤–∞–ª–∏–¥–Ω—ã–µ `tp/ep`

### –†–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ –æ—Ç USB

–ß–∞—Å—Ç–æ –ø—Ä–∏—á–∏–Ω–∞ –≤ –∂–µ–ª–µ–∑–µ:
- –ø—Ä–æ—Å–∞–¥–∫–∞ –ø–∏—Ç–∞–Ω–∏—è
- –ø–ª–æ—Ö–æ–π –∫–∞–±–µ–ª—å/–ë–ü
- –Ω–µ—Ç –æ–±—â–µ–π –∑–µ–º–ª–∏
- `ECHO` –±–µ–∑ –¥–µ–ª–∏—Ç–µ–ª—è
- `DS18B20` –±–µ–∑ `4.7k` pull-up

### –ü–æ—Å–ª–µ `uploadfs` ‚Äú–≤—Å—ë —Å–ª–æ–º–∞–ª–æ—Å—å‚Äù

–û–±—ã—á–Ω–æ —ç—Ç–æ –Ω–µ –±–∞–≥, –∞ –æ–∂–∏–¥–∞–µ–º–æ —Å—Ç–µ—Ä—Ç—ã–π `LittleFS`:
- –∫–æ–Ω—Ñ–∏–≥ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç -> –∑–∞–≥—Ä—É–∂–µ–Ω—ã –¥–µ—Ñ–æ–ª—Ç—ã
- –∏—Å—Ç–æ—Ä–∏—è –æ—á–∏—â–µ–Ω–∞
- –Ω—É–∂–Ω–æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ (–æ—Å–æ–±–µ–Ω–Ω–æ Telegram token)

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞

```text
water-level-sensor/
‚îú‚îÄ‚îÄ platformio.ini
‚îú‚îÄ‚îÄ README.md
‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îú‚îÄ‚îÄ main.cpp            # setup/loop, Wi-Fi/NTP/OTA, serial CLI
‚îÇ   ‚îú‚îÄ‚îÄ config.h            # –∫–æ–Ω—Ñ–∏–≥ + defaults + load/save/sanitize
‚îÇ   ‚îú‚îÄ‚îÄ sensor.h            # HC-SR04 (–º–µ–¥–∏–∞–Ω–∞+EMA) + DS18B20
‚îÇ   ‚îú‚îÄ‚îÄ ota_update.h        # auto-OTA: –ø—Ä–æ–≤–µ—Ä–∫–∞ version.json + ESPhttpUpdate
‚îÇ   ‚îú‚îÄ‚îÄ storage.h           # hist.bin, –∫–æ–ª—å—Ü–µ–≤–æ–π –±—É—Ñ–µ—Ä –∏—Å—Ç–æ—Ä–∏–∏
‚îÇ   ‚îú‚îÄ‚îÄ webserver.h         # HTTP API + –≤–µ–±-–º–∞—Ä—à—Ä—É—Ç—ã
‚îÇ   ‚îú‚îÄ‚îÄ mqtt_handler.h      # MQTT + HA discovery
‚îÇ   ‚îú‚îÄ‚îÄ telegram_handler.h  # Telegram –∫–æ–º–∞–Ω–¥—ã/–∞–ª–µ—Ä—Ç—ã/—Å—Ç–∞—Ä—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
‚îÇ   ‚îî‚îÄ‚îÄ debug_log.h         # –∑–µ—Ä–∫–∞–ª–∏—Ä–æ–≤–∞–Ω–∏–µ serial –ª–æ–≥–æ–≤ –≤ RAM (/api/logs)
‚îî‚îÄ‚îÄ data/
    ‚îú‚îÄ‚îÄ index.html          # –¥–∞—à–±–æ—Ä–¥
    ‚îú‚îÄ‚îÄ set.html            # –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
    ‚îú‚îÄ‚îÄ c.js                # TinyChart
    ‚îî‚îÄ‚îÄ s.css               # —Å—Ç–∏–ª–∏
```
