# WaterSense ‚Äî –î–∞—Ç—á–∏–∫ —É—Ä–æ–≤–Ω—è –≤–æ–¥—ã

**Wemos D1 Mini (ESP8266) + HC-SR04 ‚Äî —É–º–Ω—ã–π –º–æ–Ω–∏—Ç–æ—Ä —É—Ä–æ–≤–Ω—è –≤–æ–¥—ã**

---

## –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏

| –§—É–Ω–∫—Ü–∏—è | –û–ø–∏—Å–∞–Ω–∏–µ |
|---|---|
| üìè –ò–∑–º–µ—Ä–µ–Ω–∏–µ | HC-SR04, —É—Å—Ä–µ–¥–Ω–µ–Ω–∏–µ N –∑–∞–º–µ—Ä–æ–≤ |
| üåê –í–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å | –ê–¥–∞–ø—Ç–∏–≤–Ω—ã–π, —Ç—ë–º–Ω–∞—è —Ç–µ–º–∞, –≥—Ä–∞—Ñ–∏–∫ |
| üìä –ò—Å—Ç–æ—Ä–∏—è | –ü–æ—á–∞—Å–æ–≤—ã–µ —Å–Ω–∏–º–∫–∏, 7 –¥–Ω–µ–π (168 –∑–∞–ø–∏—Å–µ–π) |
| üì° MQTT | –ü—É–±–ª–∏–∫–∞—Ü–∏—è level / volume / distance / json |
| ‚úàÔ∏è Telegram | –ë–æ—Ç —Å –∫–æ–º–∞–Ω–¥–∞–º–∏ + –ø–æ—Ä–æ–≥–æ–≤—ã–µ –∞–ª–µ—Ä—Ç—ã |
| üîÑ OTA | ArduinoOTA + –≤–µ–±-–∑–∞–≥—Ä—É–∑–∫–∞ /update |
| üì∂ AP-—Ä–µ–∂–∏–º | –ü–µ—Ä–≤–∏—á–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –±–µ–∑ —Ö–∞—Ä–¥–∫–æ–¥–∞ WiFi |
| üïí NTP | –†–µ–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è –¥–ª—è –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –º–µ—Ç–æ–∫ |
| üì• –≠–∫—Å–ø–æ—Ä—Ç | CSV-–≤—ã–≥—Ä—É–∑–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏ |
| üîî –ê–ª–µ—Ä—Ç—ã | –û–ø–æ–≤–µ—â–µ–Ω–∏—è Telegram –ø—Ä–∏ –Ω–∏–∑–∫–æ–º/–≤—ã—Å–æ–∫–æ–º —É—Ä–æ–≤–Ω–µ |
| üìÖ –î–Ω–µ–≤–Ω–æ–π –æ—Ç—á—ë—Ç | Telegram-—Å–≤–æ–¥–∫–∞ –≤ –ø–æ–ª–Ω–æ—á—å |

---

## –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ HC-SR04

```
Wemos D1 Mini    HC-SR04
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ    ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
5V         ‚îÄ‚îÄ‚ñ∂  VCC
GND        ‚îÄ‚îÄ‚ñ∂  GND
D5 (GPIO14)‚îÄ‚îÄ‚ñ∂  TRIG
D6 (GPIO12)‚îÄ‚îÄ‚ñ∂  ECHO
```

> **–í–∞–∂–Ω–æ:** Echo HC-SR04 –≤—ã–¥–∞—ë—Ç 5V! –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –¥–µ–ª–∏—Ç–µ–ª—å –Ω–∞–ø—Ä—è–∂–µ–Ω–∏—è:
> ECHO ‚Üí R1(10–∫Œ©) ‚Üí D6, R2(20–∫Œ©) ‚Üí GND
> –ò–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ HC-SR04 –Ω–∞ 3.3V (–≤–∞—Ä–∏–∞–Ω—Ç HC-SR04+).

---

## –£—Å—Ç–∞–Ω–æ–≤–∫–∞ (PlatformIO)

```bash
# –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å PlatformIO CLI
pip install platformio

# –ö–ª–æ–Ω–∏—Ä–æ–≤–∞—Ç—å / –≤–æ–π—Ç–∏ –≤ –ø–∞–ø–∫—É
cd water-level-sensor

# –°–æ–±—Ä–∞—Ç—å –∏ –∑–∞–≥—Ä—É–∑–∏—Ç—å –ø—Ä–æ—à–∏–≤–∫—É
pio run -t upload

# –ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª–æ–≤—É—é —Å–∏—Å—Ç–µ–º—É (web UI)
pio run -t uploadfs

# –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø–æ—Ä—Ç–∞
pio device monitor
```

---

## –ü–µ—Ä–≤—ã–π –∑–∞–ø—É—Å–∫

1. –ü—Ä–∏ –ø–µ—Ä–≤–æ–º –≤–∫–ª—é—á–µ–Ω–∏–∏ (–±–µ–∑ –Ω–∞—Å—Ç—Ä–æ–µ–∫ WiFi) —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –ø–æ–¥–Ω–∏–º–∞–µ—Ç —Ç–æ—á–∫—É –¥–æ—Å—Ç—É–ø–∞:
   **SSID:** `WaterSensor-XXXXXX`  **–ü–∞—Ä–æ–ª—å:** `watersensor`
2. –ü–æ–¥–∫–ª—é—á–∏—Ç–µ—Å—å, –æ—Ç–∫—Ä–æ–π—Ç–µ `http://192.168.4.1`
3. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ **–ù–∞—Å—Ç—Ä–æ–π–∫–∏**, –≤–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã WiFi, —Å–æ—Ö—Ä–∞–Ω–∏—Ç–µ
4. –£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—Å—è –∏ –ø–æ–¥–∫–ª—é—á–∏—Ç—Å—è –∫ –≤–∞—à–µ–π —Å–µ—Ç–∏
5. –ù–∞–π–¥–∏—Ç–µ IP –≤ —Ä–æ—É—Ç–µ—Ä–µ –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ `http://watersensor.local`

---

## –ö–∞–ª–∏–±—Ä–æ–≤–∫–∞

- **–†–∞—Å—Å—Ç–æ—è–Ω–∏–µ –¥–æ –¥–Ω–∞** ‚Äî –ø–æ–º–µ—Å—Ç–∏—Ç–µ –¥–∞—Ç—á–∏–∫, —É–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ –±–æ—á–∫–∞ –ø—É—Å—Ç–∞—è, –∏–∑–º–µ—Ä—å—Ç–µ —Ä—É–ª–µ—Ç–∫–æ–π —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ –æ—Ç –¥–∞—Ç—á–∏–∫–∞ –¥–æ –¥–Ω–∞
- **–†–∞—Å—Å—Ç–æ—è–Ω–∏–µ –ø–æ–ª–Ω–æ–π –±–æ—á–∫–∏** ‚Äî ‚âà 3‚Äì5 —Å–º (–∑–∞–∑–æ—Ä –¥–æ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–≥–æ —É—Ä–æ–≤–Ω—è –≤–æ–¥—ã)
- **–î–∏–∞–º–µ—Ç—Ä** ‚Äî –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π –¥–∏–∞–º–µ—Ç—Ä –±–æ—á–∫–∏ –≤ —Å–º (–¥–ª—è —Ä–∞—Å—á—ë—Ç–∞ –ª–∏—Ç—Ä–æ–≤)

---

## –í–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å

| URL | –û–ø–∏—Å–∞–Ω–∏–µ |
|---|---|
| `/` | –î–∞—à–±–æ—Ä–¥ —Å –≥—Ä–∞—Ñ–∏–∫–æ–º –∏ —Å—Ç–∞—Ç—É—Å–æ–º |
| `/set.html` | –ù–∞—Å—Ç—Ä–æ–π–∫–∏ |
| `/update` | –í–µ–±-OTA –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–æ—à–∏–≤–∫–∏ |
| `/api/status` | JSON —Ç–µ–∫—É—â–µ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è |
| `/api/history?h=24` | JSON –∏—Å—Ç–æ—Ä–∏–∏ (24/72/168 —á–∞—Å–æ–≤) |
| `/api/export` | –°–∫–∞—á–∞—Ç—å –∏—Å—Ç–æ—Ä–∏—é CSV |
| `/api/measure` POST | –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω—ã–π –∑–∞–º–µ—Ä |
| `/api/config` GET/POST | –ß—Ç–µ–Ω–∏–µ/–∑–∞–ø–∏—Å—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ |
| `/api/reset` POST | –°–±—Ä–æ—Å –∫ –∑–∞–≤–æ–¥—Å–∫–∏–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º |

---

## MQTT —Ç–æ–ø–∏–∫–∏

–ü—Ä–∏ –±–∞–∑–æ–≤–æ–º —Ç–æ–ø–∏–∫–µ `home/water`:

| –¢–æ–ø–∏–∫ | –ó–Ω–∞—á–µ–Ω–∏–µ |
|---|---|
| `home/water/level` | –£—Ä–æ–≤–µ–Ω—å % |
| `home/water/distance` | –†–∞—Å—Å—Ç–æ—è–Ω–∏–µ, —Å–º |
| `home/water/volume` | –û–±—ä—ë–º –≤–æ–¥—ã, –ª |
| `home/water/free` | –°–≤–æ–±–æ–¥–Ω—ã–π –æ–±—ä—ë–º, –ª |
| `home/water/json` | JSON —Å–æ –≤—Å–µ–º–∏ –¥–∞–Ω–Ω—ã–º–∏ |
| `watersensor/<chip_id>/status` | `online` / `offline` (LWT) |

---

## –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Home Assistant

### –°–ø–æ—Å–æ–± 1 ‚Äî MQTT Auto-Discovery (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è, –Ω–µ—Ç YAML)

–í–∫–ª—é—á–∏—Ç—å MQTT –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ ‚Üí –ø—Ä–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏ –∫ –±—Ä–æ–∫–µ—Ä—É —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ
–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–ø—É–±–ª–∏–∫—É–µ—Ç –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –≤ —Ç–æ–ø–∏–∫–∏ `homeassistant/sensor/...`.

Home Assistant –æ–±–Ω–∞—Ä—É–∂–∏—Ç **4 —Å—É—â–Ω–æ—Å—Ç–∏** –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏:

| –°—É—â–Ω–æ—Å—Ç—å | –ò–∫–æ–Ω–∫–∞ | Unit |
|---|---|---|
| `sensor.watersense_—É—Ä–æ–≤–µ–Ω—å` | üåä | % |
| `sensor.watersense_–æ–±—ä—ë–º` | ü™£ | L |
| `sensor.watersense_—Å–≤–æ–±–æ–¥–Ω–æ` | ‚¨ú | L |
| `sensor.watersense_—Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ` | üìè | cm |

–£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –∫–∞–∫ **–Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ–µ** –∫–æ–≥–¥–∞ ESP8266 –≤—ã–∫–ª—é—á–µ–Ω
(LWT `offline` —á–µ—Ä–µ–∑ 15 —Å–µ–∫).

> **–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è:** Home Assistant —Å —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω–æ–π –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–µ–π MQTT + —Ç–æ—Ç –∂–µ MQTT-–±—Ä–æ–∫–µ—Ä.

---

### –°–ø–æ—Å–æ–± 2 ‚Äî REST API (—Ä–µ–∑–µ—Ä–≤–Ω—ã–π, –±–µ–∑ MQTT)

–î–æ–±–∞–≤–∏—Ç—å –≤ `configuration.yaml` ‚Äî –∑–∞–º–µ–Ω–∏—Ç—å IP –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `watersensor.local`:

```yaml
rest:
  - resource: http://192.168.1.X/api/status
    scan_interval: 30
    sensor:
      - name: "–£—Ä–æ–≤–µ–Ω—å –≤–æ–¥—ã"
        value_template: "{{ value_json.level }}"
        unit_of_measurement: "%"
        state_class: measurement
        icon: mdi:waves

      - name: "–û–±—ä—ë–º –≤–æ–¥—ã"
        value_template: "{{ value_json.volume }}"
        unit_of_measurement: "L"
        device_class: volume
        state_class: measurement
        icon: mdi:barrel

      - name: "–°–≤–æ–±–æ–¥–Ω–æ –≤ –±–æ—á–∫–µ"
        value_template: "{{ value_json.free }}"
        unit_of_measurement: "L"
        device_class: volume
        state_class: measurement
        icon: mdi:barrel-outline

      - name: "–†–∞—Å—Å—Ç–æ—è–Ω–∏–µ –¥–∞—Ç—á–∏–∫–∞"
        value_template: "{{ value_json.distance }}"
        unit_of_measurement: "cm"
        device_class: distance
        state_class: measurement
```

> –†–∞–±–æ—Ç–∞–µ—Ç –±–µ–∑ MQTT ‚Äî HA —Å–∞–º –æ–ø—Ä–∞—à–∏–≤–∞–µ—Ç —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥.

---

### –ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏ –≤ HA (–ø—Ä–∏–º–µ—Ä—ã)

```yaml
# –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø—Ä–∏ –Ω–∏–∑–∫–æ–º —É—Ä–æ–≤–Ω–µ –≤–æ–¥—ã
automation:
  - alias: "–ú–∞–ª–æ –≤–æ–¥—ã –≤ –±–æ—á–∫–µ"
    trigger:
      - platform: numeric_state
        entity_id: sensor.watersense_—É—Ä–æ–≤–µ–Ω—å
        below: 20
    action:
      - service: notify.mobile_app
        data:
          title: "üíß –ú–∞–ª–æ –≤–æ–¥—ã!"
          message: "–£—Ä–æ–≤–µ–Ω—å –≤–æ–¥—ã: {{ states('sensor.watersense_—É—Ä–æ–≤–µ–Ω—å') }}%"

  # –í–∫–ª—é—á–∏—Ç—å –Ω–∞—Å–æ—Å –ø—Ä–∏ –Ω–∏–∑–∫–æ–º —É—Ä–æ–≤–Ω–µ
  - alias: "–í–∫–ª—é—á–∏—Ç—å –Ω–∞—Å–æ—Å"
    trigger:
      - platform: numeric_state
        entity_id: sensor.watersense_—É—Ä–æ–≤–µ–Ω—å
        below: 15
    action:
      - service: switch.turn_on
        target:
          entity_id: switch.water_pump
```

---

## Telegram-–±–æ—Ç

–ö–æ–º–∞–Ω–¥—ã:
- `/level` –∏–ª–∏ `/—É—Ä–æ–≤–µ–Ω—å` ‚Äî —Ç–µ–∫—É—â–∏–π —É—Ä–æ–≤–µ–Ω—å
- `/status` –∏–ª–∏ `/—Å—Ç–∞—Ç—É—Å` ‚Äî –ø–æ–ª–Ω—ã–π —Å—Ç–∞—Ç—É—Å
- `/help` –∏–ª–∏ `/–ø–æ–º–æ—â—å` ‚Äî —Å–ø–∏—Å–æ–∫ –∫–æ–º–∞–Ω–¥

–ê–ª–µ—Ä—Ç—ã –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ –≤—ã—Ö–æ–¥–µ –∑–∞ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–Ω—ã–µ –ø–æ—Ä–æ–≥–∏.

---

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞

```
water-level-sensor/
‚îú‚îÄ‚îÄ platformio.ini
‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îú‚îÄ‚îÄ main.cpp            # –û—Å–Ω–æ–≤–Ω–æ–π —Ü–∏–∫–ª
‚îÇ   ‚îú‚îÄ‚îÄ config.h            # –ö–æ–Ω—Ñ–∏–≥, load/save
‚îÇ   ‚îú‚îÄ‚îÄ sensor.h            # HC-SR04 –¥—Ä–∞–π–≤–µ—Ä
‚îÇ   ‚îú‚îÄ‚îÄ storage.h           # –ö–æ–ª—å—Ü–µ–≤–æ–π –±—É—Ñ–µ—Ä (LittleFS)
‚îÇ   ‚îú‚îÄ‚îÄ webserver.h         # HTTP –º–∞—Ä—à—Ä—É—Ç—ã
‚îÇ   ‚îú‚îÄ‚îÄ mqtt_handler.h      # MQTT –∫–ª–∏–µ–Ω—Ç
‚îÇ   ‚îî‚îÄ‚îÄ telegram_handler.h  # Telegram –±–æ—Ç
‚îî‚îÄ‚îÄ data/                   # LittleFS (–≤–µ–±-—Ñ–∞–π–ª—ã)
    ‚îú‚îÄ‚îÄ index.html          # –î–∞—à–±–æ—Ä–¥
    ‚îú‚îÄ‚îÄ set.html            # –ù–∞—Å—Ç—Ä–æ–π–∫–∏
    ‚îú‚îÄ‚îÄ s.css               # –°—Ç–∏–ª–∏
    ‚îî‚îÄ‚îÄ c.js                # Tiny chart (~4KB)
```
