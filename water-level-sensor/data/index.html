<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>WaterSense ‚Äî –î–∞—à–±–æ—Ä–¥</title>
<link rel="stylesheet" href="/s.css">
<style>
.gauge{display:flex;flex-direction:column;align-items:center;padding:8px 0}
.gring{width:140px;height:140px;border-radius:50%;display:flex;align-items:center;justify-content:center;position:relative;--p:0}
.gring::before{content:'';position:absolute;inset:0;border-radius:50%;background:conic-gradient(var(--accent) calc(var(--p)*1%),var(--card2) 0)}
.gring::after{content:'';position:absolute;width:100px;height:100px;border-radius:50%;background:var(--card)}
.gtext{position:relative;z-index:1;text-align:center;line-height:1.2}
.dbgpre{margin:10px 0 0;background:#0a1220;border:1px solid #22344f;border-radius:12px;padding:10px;min-height:180px;max-height:320px;overflow:auto;color:#b9d4ff;font:12px/1.4 ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace;white-space:pre-wrap;word-break:break-word}
</style>
</head>
<body>
<nav class="nav">
  <div class="brand">
    <svg width="22" height="22" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2c-5.33 4-8 7.56-8 10.5C4 17.53 7.58 22 12 22s8-4.47 8-9.5C20 9.56 17.33 6 12 2z"/></svg>
    <span>WaterSense</span>
  </div>
  <div class="nav-links">
    <a href="/" class="on">–î–∞—à–±–æ—Ä–¥</a>
    <a href="/set.html">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</a>
  </div>
</nav>

<div class="wrap">
  <!-- Status bar -->
  <div class="sbar">
    <span><span class="sdot r" id="dw"></span><span id="lw" style="font-size:.85rem">WiFi</span></span>
    <span><span class="sdot r" id="dm"></span><span id="lm" style="font-size:.85rem">MQTT</span></span>
    <span><span class="sdot r" id="dt"></span><span id="lt" style="font-size:.85rem">Telegram</span></span>
    <span class="ts" id="upd"></span>
  </div>

  <!-- Top stat cards -->
  <div class="grid g4" style="margin-bottom:18px">
    <div class="card">
      <div class="clabel">–£—Ä–æ–≤–µ–Ω—å –≤–æ–¥—ã</div>
      <div><span class="cval" id="vl">--</span><span class="cunit">%</span></div>
      <div class="lbar"><div class="lfill" id="lb" style="width:0%"></div></div>
      <div class="ts" id="lhint">--</div>
    </div>
    <div class="card" style="display:flex;flex-direction:column;align-items:center;justify-content:center">
      <div class="gauge">
        <div class="gring" id="gring">
          <div class="gtext">
            <div class="cval" id="vg" style="font-size:1.8rem">--</div>
            <div class="ts">%</div>
          </div>
        </div>
      </div>
    </div>
    <div class="card">
      <div class="clabel">–û–±—ä—ë–º –≤ –±–æ—á–∫–µ</div>
      <div><span class="cval" id="vv">--</span><span class="cunit">–ª</span></div>
      <div class="ts" style="margin-top:8px">–∏–∑ <span id="vtotal">--</span> –ª</div>
    </div>
    <div class="card">
      <div class="clabel">–†–∞—Å—Å—Ç–æ—è–Ω–∏–µ</div>
      <div><span class="cval" id="vd">--</span><span class="cunit">—Å–º</span></div>
      <div class="ts" style="margin-top:8px">–°–≤–æ–±–æ–¥–Ω–æ: <span id="vfree">--</span> –ª</div>
    </div>
    <div class="card">
      <div class="clabel">–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ DS18B20</div>
      <div><span class="cval" id="vt">--</span><span class="cunit">¬∞C</span></div>
      <div class="ts" id="thint" style="margin-top:8px">&nbsp;</div>
    </div>
  </div>

  <!-- Chart -->
  <div class="card" style="margin-bottom:18px">
    <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:10px;margin-bottom:4px">
      <div class="clabel" style="margin:0">–ò—Å—Ç–æ—Ä–∏—è —É—Ä–æ–≤–Ω—è</div>
      <div class="ctrls">
        <button class="cbtn on" onclick="loadH(24,this)">24—á</button>
        <button class="cbtn" onclick="loadH(72,this)">3 –¥–Ω—è</button>
        <button class="cbtn" onclick="loadH(168,this)">7 –¥–Ω–µ–π</button>
      </div>
    </div>
    <div class="chartbox"><canvas id="ch"></canvas></div>
    <div class="no-data" id="nd" style="display:none">–ó–∞–ø–∏—Å–∏ –ø–æ—è–≤—è—Ç—Å—è —á–µ—Ä–µ–∑ —á–∞—Å –ø–æ—Å–ª–µ –∑–∞–ø—É—Å–∫–∞.</div>
  </div>

  <div class="card" style="margin-bottom:18px">
    <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:10px;margin-bottom:4px">
      <div class="clabel" style="margin:0">–ò—Å—Ç–æ—Ä–∏—è —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—ã</div>
      <div class="ts">–ü–µ—Ä–∏–æ–¥ —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å –≥—Ä–∞—Ñ–∏–∫–æ–º —É—Ä–æ–≤–Ω—è</div>
    </div>
    <div class="chartbox"><canvas id="cht"></canvas></div>
    <div class="no-data" id="ndt" style="display:none">–ù–µ—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—ã.</div>
  </div>

  <!-- Details & Actions -->
  <div class="grid g2">
    <div class="card">
      <div class="clabel">–ü–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏</div>
      <div class="drow"><span class="dlbl">IP –∞–¥—Ä–µ—Å</span><span class="dval" id="dip">--</span></div>
      <div class="drow"><span class="dlbl">WiFi —Å–∏–≥–Ω–∞–ª</span><span class="dval" id="drssi">--</span></div>
      <div class="drow"><span class="dlbl">–°–≤–æ–±–æ–¥–Ω–æ –û–ó–£</span><span class="dval" id="dheap">--</span></div>
      <div class="drow"><span class="dlbl">–î–∏–∞–º–µ—Ç—Ä –±–æ—á–∫–∏</span><span class="dval" id="ddiam">--</span></div>
      <div class="drow"><span class="dlbl">–ó–∞–ø–∏—Å–µ–π –∏—Å—Ç–æ—Ä–∏–∏</span><span class="dval" id="drec">--</span></div>
      <div class="drow"><span class="dlbl">–í–µ—Ä—Å–∏—è –ø—Ä–æ—à–∏–≤–∫–∏</span><span class="dval" id="dver">--</span></div>
    </div>
    <div class="card">
      <div class="clabel">–î–µ–π—Å—Ç–≤–∏—è</div>
      <button class="btn btn-p" onclick="measure()">‚ö° –ó–∞–º–µ—Ä —Å–µ–π—á–∞—Å</button>
      <button class="btn btn-s" onclick="toggleDebug()">üêû –†–µ–∂–∏–º –æ—Ç–ª–∞–¥–∫–∏</button>
      <a href="/api/export"><button class="btn btn-s">üì• –≠–∫—Å–ø–æ—Ä—Ç CSV</button></a>
      <a href="/update"><button class="btn btn-s">üîÑ –û–±–Ω–æ–≤–∏—Ç—å –ø—Ä–æ—à–∏–≤–∫—É</button></a>
      <button class="btn btn-s" onclick="if(confirm('–û—á–∏—Å—Ç–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é?'))fetch('/api/history',{method:'DELETE'}).then(()=>{showToast('–ò—Å—Ç–æ—Ä–∏—è –æ—á–∏—â–µ–Ω–∞','ok');loadH(24)})">üóë –û—á–∏—Å—Ç–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é</button>
      <button class="btn btn-d" style="margin-top:14px" onclick="if(confirm('–°–±—Ä–æ—Å–∏—Ç—å –≤—Å–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏?'))fetch('/api/reset',{method:'POST'})">–°–±—Ä–æ—Å –Ω–∞—Å—Ç—Ä–æ–µ–∫</button>
    </div>
  </div>

  <div class="card" id="dbgCard" style="margin-top:18px;display:none">
    <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap">
      <div class="clabel" style="margin:0">–û—Ç–ª–∞–¥–∫–∞ (–ª–æ–≥–∏ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞)</div>
      <div class="ts" id="dbgState">–í—ã–∫–ª.</div>
    </div>
    <pre class="dbgpre" id="dbgLog">–ù–∞–∂–º–∏—Ç–µ "–†–µ–∂–∏–º –æ—Ç–ª–∞–¥–∫–∏".</pre>
  </div>
</div>

<div class="toast" id="toast"></div>
<script src="/c.js"></script>
<script>
var chart=null,tempChart=null,curH=24,dbgOn=false,dbgTimer=null;

function showToast(m,t){
  var el=document.getElementById('toast');
  el.textContent=m; el.className='toast show '+(t||'');
  setTimeout(function(){el.className='toast';},3000);
}

function dot(id,on){document.getElementById(id).className='sdot '+(on?'g':'r');}

function barColor(pct){
  if(pct<20)return'var(--err)';
  if(pct<40)return'var(--warn)';
  return'linear-gradient(90deg,var(--accent2),var(--accent))';
}

function applyStatus(d){
  var pct=parseFloat(d.level)||0;
  document.getElementById('vl').textContent=pct.toFixed(1);
  document.getElementById('vg').textContent=pct.toFixed(1);
  document.getElementById('lb').style.cssText='width:'+pct+'%;background:'+barColor(pct);
  document.getElementById('gring').style.setProperty('--p',pct);
  // level hint
  var hint=pct<20?'‚ö†Ô∏è –ú–∞–ª–æ –≤–æ–¥—ã!':pct>90?'üîµ –ü–æ—á—Ç–∏ –ø–æ–ª–Ω–∞—è':'';
  document.getElementById('lhint').textContent=hint||(' ');

  document.getElementById('vv').textContent=parseFloat(d.volume).toFixed(1);
  document.getElementById('vtotal').textContent=parseFloat(d.total).toFixed(1);
  document.getElementById('vfree').textContent=parseFloat(d.free).toFixed(1);
  document.getElementById('vd').textContent=parseFloat(d.distance).toFixed(1);

  var temp=parseFloat(d.temp);
  if(!isNaN(temp)){
    document.getElementById('vt').textContent=temp.toFixed(1);
    var th=temp<5?'ü•∂ –û—á–µ–Ω—å —Ö–æ–ª–æ–¥–Ω–∞—è':temp>35?'üî• –ì–æ—Ä—è—á–∞—è':'';
    document.getElementById('thint').textContent=th||'\u00a0';
  } else {
    document.getElementById('vt').textContent='--';
    document.getElementById('thint').textContent='–î–∞—Ç—á–∏–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω';
  }

  dot('dw',d.wifi); dot('dm',d.mqtt); dot('dt',d.tg);
  document.getElementById('lw').textContent=d.wifi?'WiFi ‚úì':'WiFi ‚úó';
  document.getElementById('lm').textContent=d.mqtt?'MQTT ‚úì':'MQTT ‚úó';
  document.getElementById('lt').textContent=d.tg?'Telegram ‚úì':'Telegram ‚úó';

  var t=new Date(d.ts*1000);
  document.getElementById('upd').textContent='–û–±–Ω–æ–≤–ª–µ–Ω–æ (–ö–∏–µ–≤): '+t.toLocaleTimeString('uk-UA',{timeZone:'Europe/Kyiv'});

  document.getElementById('dip').textContent=d.ip;
  document.getElementById('drssi').textContent=d.rssi+' dBm';
  document.getElementById('dheap').textContent=(d.heap/1024).toFixed(0)+' KB';
  document.getElementById('ddiam').textContent=d.diameter>0?d.diameter+' —Å–º':'–ù–µ –∑–∞–¥–∞–Ω';
  document.getElementById('drec').textContent=d.records+' / '+(d.records_max||168);
  document.getElementById('dver').textContent=d.version||'‚Äî';
}

function fetchStatus(){
  fetch('/api/status').then(function(r){return r.json();}).then(applyStatus)
    .catch(function(){dot('dw',false);});
}

function renderLogs(lines){
  var el=document.getElementById('dbgLog');
  el.textContent=(lines&&lines.length)?lines.join('\n'):'(–ø–æ–∫–∞ –Ω–µ—Ç –ª–æ–≥–æ–≤)';
  el.scrollTop=el.scrollHeight;
}

function fetchLogs(){
  if(!dbgOn)return;
  fetch('/api/logs').then(function(r){return r.json();}).then(function(d){
    renderLogs(d.lines||[]);
    document.getElementById('dbgState').textContent='–í–∫–ª. ‚Ä¢ uptime '+(d.uptime||0)+'—Å';
  }).catch(function(){
    document.getElementById('dbgState').textContent='–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è /api/logs';
  });
}

function toggleDebug(){
  dbgOn=!dbgOn;
  document.getElementById('dbgCard').style.display=dbgOn?'block':'none';
  document.getElementById('dbgState').textContent=dbgOn?'–í–∫–ª.':'–í—ã–∫–ª.';
  if(dbgOn){
    fetchLogs();
    if(!dbgTimer) dbgTimer=setInterval(fetchLogs,2000);
  } else {
    if(dbgTimer){ clearInterval(dbgTimer); dbgTimer=null; }
  }
}

function loadH(h,btn){
  curH=h;
  document.querySelectorAll('.cbtn').forEach(function(b){b.classList.remove('on');});
  if(btn)btn.classList.add('on');
  fetch('/api/history?h='+h).then(function(r){return r.json();}).then(function(data){
    var labels=data.labels||[];
    var cv=document.getElementById('ch');
    var nd=document.getElementById('nd');
    var tcv=document.getElementById('cht');
    var ndt=document.getElementById('ndt');
    if(!labels.length){
      nd.style.display='block';cv.style.display='none';
      ndt.style.display='block';tcv.style.display='none';
      return;
    }
    nd.style.display='none'; cv.style.display='block';
    if(!chart)chart=new TinyChart(cv,{
      formatY:function(v,d){
        var txt=v.toFixed(1)+'%';
        if(!d || !d.s || !d.s.length) return txt;
        var k=NaN;
        for(var i=0;i<d.v.length;i++){
          var pv=parseFloat(d.v[i]), sv=parseFloat(d.s[i]);
          if(!isNaN(pv) && !isNaN(sv) && pv>0){ k=sv/pv; break; }
        }
        if(isNaN(k)) return txt;
        return txt+'  ('+(v*k).toFixed(1)+' –ª)';
      },
      formatTooltip:function(idx,d,v){
        var txt=(d.l[idx]||'')+': '+v.toFixed(1)+'%';
        var sv=parseFloat((d.s||[])[idx]);
        if(!isNaN(sv)) txt+=' / '+sv.toFixed(1)+' –ª';
        return txt;
      }
    });
    chart.setData(labels,data.values,data.volumes||[]);

    var tLabels=[], tValues=[];
    (data.temps||[]).forEach(function(v,i){
      var n=parseFloat(v);
      if(!isNaN(n) && labels[i]!==undefined){
        tLabels.push(labels[i]);
        tValues.push(n);
      }
    });
    if(!tValues.length){
      ndt.style.display='block';tcv.style.display='none';
      return;
    }
    ndt.style.display='none'; tcv.style.display='block';
    if(!tempChart)tempChart=new TinyChart(tcv,{
      line:'#ff8c42',
      fill:'rgba(255,140,66,0.14)',
      unit:'¬∞C'
    });
    tempChart.setData(tLabels,tValues);
  });
}

function measure(){
  fetch('/api/measure',{method:'POST'}).then(function(r){return r.json();})
    .then(function(d){applyStatus(d);showToast('–ó–∞–º–µ—Ä –≤—ã–ø–æ–ª–Ω–µ–Ω ‚úì','ok');})
    .catch(function(){showToast('–û—à–∏–±–∫–∞ –∑–∞–º–µ—Ä–∞','err');});
}

fetchStatus();
loadH(24);
setInterval(fetchStatus,5000);
setInterval(function(){loadH(curH);},60000);
</script>
</body>
</html>
