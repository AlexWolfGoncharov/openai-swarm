<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>WaterSense ‚Äî –ù–∞—Å—Ç—Ä–æ–π–∫–∏</title>
<link rel="stylesheet" href="/s.css">
</head>
<body>
<nav class="nav">
  <div class="brand">
    <svg width="22" height="22" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2c-5.33 4-8 7.56-8 10.5C4 17.53 7.58 22 12 22s8-4.47 8-9.5C20 9.56 17.33 6 12 2z"/></svg>
    <span>WaterSense</span>
  </div>
  <div class="nav-links">
    <a href="/">–î–∞—à–±–æ—Ä–¥</a>
    <a href="/set.html" class="on">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</a>
  </div>
</nav>

<div class="wrap">
  <form id="frm">

    <!-- WiFi -->
    <div class="sec">üì∂ WiFi</div>
    <div class="row2">
      <div class="fg"><label>–ù–∞–∑–≤–∞–Ω–∏–µ —Å–µ—Ç–∏ (SSID)</label><input type="text" name="ws" placeholder="MyWiFi" maxlength="63"></div>
      <div class="fg"><label>–ü–∞—Ä–æ–ª—å</label><input type="password" name="wp" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" maxlength="63"></div>
    </div>
    <div class="row2">
      <div class="fg">
        <label>–ù–∞–π—Ç–∏ —Å–µ—Ç—å Wi-Fi</label>
        <select id="wifiList">
          <option value="">–ù–∞–∂–º–∏—Ç–µ ¬´–°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å Wi-Fi¬ª</option>
        </select>
        <p class="hint">–í—ã–±–µ—Ä–∏—Ç–µ —Å–µ—Ç—å –∏–∑ —Å–ø–∏—Å–∫–∞, —á—Ç–æ–±—ã –ø–æ–¥—Å—Ç–∞–≤–∏—Ç—å SSID –≤ –ø–æ–ª–µ –≤—ã—à–µ</p>
      </div>
      <div class="fg" style="display:flex;align-items:flex-end">
        <button type="button" id="scanWifiBtn" class="btn btn-s" style="width:auto;padding:11px 20px">–°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å Wi-Fi</button>
      </div>
    </div>
    <p class="hint">–ï—Å–ª–∏ WiFi –Ω–µ —É–∫–∞–∑–∞–Ω –∏–ª–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω ‚Äî —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –∑–∞–ø—É—Å—Ç–∏—Ç —Ç–æ—á–∫—É –¥–æ—Å—Ç—É–ø–∞ <b>WaterSensor-XXXXXX</b> (–ø–∞—Ä–æ–ª—å: watersensor)</p>

    <!-- Sensor -->
    <div class="sec">üìè –î–∞—Ç—á–∏–∫ HC-SR04</div>
    <div class="row2">
      <div class="fg">
        <label>–ü–∏–Ω TRIG (GPIO –Ω–æ–º–µ—Ä)</label>
        <input type="number" name="tp" min="0" max="16" placeholder="14">
        <p class="hint">D5 = GPIO14, D6 = GPIO12, D7 = GPIO13</p>
      </div>
      <div class="fg">
        <label>–ü–∏–Ω ECHO (GPIO –Ω–æ–º–µ—Ä)</label>
        <input type="number" name="ep" min="0" max="16" placeholder="12">
      </div>
    </div>
    <div class="row2">
      <div class="fg">
        <label>–†–∞—Å—Å—Ç–æ—è–Ω–∏–µ –¥–æ –¥–Ω–∞ –ø—É—Å—Ç–æ–π –±–æ—á–∫–∏ (—Å–º)</label>
        <input type="number" name="ed" step="0.1" min="1" max="500" placeholder="100">
        <p class="hint">–°–∫–æ–ª—å–∫–æ —Å–º –æ—Ç –¥–∞—Ç—á–∏–∫–∞ –¥–æ –¥–Ω–∞ –±–æ—á–∫–∏</p>
      </div>
      <div class="fg">
        <label>–†–∞—Å—Å—Ç–æ—è–Ω–∏–µ –¥–æ –≤–æ–¥—ã –ø—Ä–∏ –ø–æ–ª–Ω–æ–π –±–æ—á–∫–µ (—Å–º)</label>
        <input type="number" name="fd" step="0.1" min="1" max="500" placeholder="5">
        <p class="hint">–ú–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ (–±–æ—á–∫–∞ –ø–æ–ª–Ω–∞—è)</p>
      </div>
    </div>
    <div class="row2">
      <div class="fg">
        <label>–í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π –¥–∏–∞–º–µ—Ç—Ä –±–æ—á–∫–∏ (—Å–º)</label>
        <input type="number" name="bd" step="0.1" min="0" max="500" placeholder="60">
        <p class="hint">0 ‚Äî –Ω–µ –≤—ã—á–∏—Å–ª—è—Ç—å –æ–±—ä—ë–º –≤ –ª–∏—Ç—Ä–∞—Ö</p>
      </div>
      <div class="fg">
        <label>–ß–∏—Å–ª–æ –∑–∞–º–µ—Ä–æ–≤ –¥–ª—è —É—Å—Ä–µ–¥–Ω–µ–Ω–∏—è (1‚Äì10)</label>
        <input type="number" name="as" min="1" max="10" placeholder="5">
      </div>
    </div>
    <div class="fg" style="max-width:260px">
      <label>–ò–Ω—Ç–µ—Ä–≤–∞–ª –∏–∑–º–µ—Ä–µ–Ω–∏–π (—Å–µ–∫—É–Ω–¥—ã)</label>
      <input type="number" name="ms" min="10" max="3600" placeholder="60">
    </div>

    <!-- DS18B20 Temperature Sensor -->
    <div class="sec">üå°Ô∏è –î–∞—Ç—á–∏–∫ —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—ã DS18B20</div>
    <label class="toggle" style="margin-bottom:14px">
      <input type="checkbox" name="de" id="tde">
      <span class="tslider"></span>
      <span>–í–∫–ª—é—á–∏—Ç—å DS18B20</span>
    </label>
    <div id="ds18Box">
      <div class="fg" style="max-width:260px">
        <label>–ü–∏–Ω –¥–∞–Ω–Ω—ã—Ö (GPIO –Ω–æ–º–µ—Ä)</label>
        <input type="number" name="dp" min="0" max="16" placeholder="2">
        <p class="hint">D4 = GPIO2. –ù—É–∂–µ–Ω –ø–æ–¥—Ç—è–≥–∏–≤–∞—é—â–∏–π —Ä–µ–∑–∏—Å—Ç–æ—Ä 4.7 –∫–û–º –∫ 3.3V –º–µ–∂–¥—É DATA –∏ VCC.</p>
      </div>
    </div>

    <!-- MQTT -->
    <div class="sec">üì° MQTT</div>
    <label class="toggle" style="margin-bottom:14px">
      <input type="checkbox" name="me" id="tme">
      <span class="tslider"></span>
      <span>–í–∫–ª—é—á–∏—Ç—å MQTT</span>
    </label>
    <div id="mqttBox">
      <div class="row2">
        <div class="fg"><label>–°–µ—Ä–≤–µ—Ä (—Ö–æ—Å—Ç –∏–ª–∏ IP)</label><input type="text" name="mh" placeholder="192.168.1.100" maxlength="63"></div>
        <div class="fg"><label>–ü–æ—Ä—Ç</label><input type="number" name="mp" min="1" max="65535" placeholder="1883"></div>
      </div>
      <div class="row2">
        <div class="fg"><label>–õ–æ–≥–∏–Ω (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label><input type="text" name="mu" placeholder="" maxlength="31"></div>
        <div class="fg"><label>–ü–∞—Ä–æ–ª—å (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label><input type="password" name="mq" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" maxlength="31"></div>
      </div>
      <div class="fg" style="max-width:360px">
        <label>–ë–∞–∑–æ–≤—ã–π —Ç–æ–ø–∏–∫</label>
        <input type="text" name="mt" placeholder="home/water" maxlength="63">
        <p class="hint">–ü—É–±–ª–∏–∫—É—é—Ç—Å—è: <b>/level</b>, <b>/distance</b>, <b>/volume</b>, <b>/free</b>, <b>/json</b></p>
      </div>
    </div>

    <!-- Telegram -->
    <div class="sec">‚úàÔ∏è Telegram</div>
    <label class="toggle" style="margin-bottom:14px">
      <input type="checkbox" name="te" id="tte">
      <span class="tslider"></span>
      <span>–í–∫–ª—é—á–∏—Ç—å Telegram –±–æ—Ç</span>
    </label>
    <div id="tgBox">
      <div class="fg">
        <label>–¢–æ–∫–µ–Ω –±–æ—Ç–∞ (–æ—Ç @BotFather)</label>
        <input type="text" name="tt" placeholder="123456789:AAB..." maxlength="127">
      </div>
      <div class="fg" style="max-width:260px">
        <label>Chat ID (–≤–∞—à –∏–ª–∏ –≥—Ä—É–ø–ø—ã)</label>
        <input type="text" name="tc" placeholder="-100123456789" maxlength="31">
        <p class="hint">–£–∑–Ω–∞—Ç—å —á–µ—Ä–µ–∑ @userinfobot</p>
      </div>
      <div class="row2">
        <div class="fg">
          <label>–û–ø–æ–≤–µ—â–µ–Ω–∏–µ ‚Äî –º–∞–ª–æ –≤–æ–¥—ã (%)</label>
          <input type="number" name="tl" min="1" max="99" step="1" placeholder="20">
          <p class="hint">–ê–ª–µ—Ä—Ç, –µ—Å–ª–∏ —É—Ä–æ–≤–µ–Ω—å –Ω–∏–∂–µ —ç—Ç–æ–≥–æ –∑–Ω–∞—á–µ–Ω–∏—è</p>
        </div>
        <div class="fg">
          <label>–û–ø–æ–≤–µ—â–µ–Ω–∏–µ ‚Äî –º–Ω–æ–≥–æ –≤–æ–¥—ã (%)</label>
          <input type="number" name="th" min="1" max="100" step="1" placeholder="95">
          <p class="hint">–ê–ª–µ—Ä—Ç, –µ—Å–ª–∏ —É—Ä–æ–≤–µ–Ω—å –≤—ã—à–µ —ç—Ç–æ–≥–æ –∑–Ω–∞—á–µ–Ω–∏—è</p>
        </div>
      </div>
      <label class="toggle">
        <input type="checkbox" name="td">
        <span class="tslider"></span>
        <span>–ï–∂–µ–¥–Ω–µ–≤–Ω—ã–π –æ—Ç—á—ë—Ç –≤ –ø–æ–ª–Ω–æ—á—å</span>
      </label>
      <div class="card" style="margin-top:16px;background:var(--card2);border-style:dashed">
        <div style="font-size:.85rem;color:var(--muted);line-height:1.7">
          <b style="color:var(--txt)">–ö–æ–º–∞–Ω–¥—ã –±–æ—Ç–∞:</b><br>
          /level ‚Äî —Ç–µ–∫—É—â–∏–π —É—Ä–æ–≤–µ–Ω—å<br>
          /status ‚Äî –ø–æ–ª–Ω—ã–π —Å—Ç–∞—Ç—É—Å —Å –æ–±—ä—ë–º–æ–º<br>
          /help ‚Äî —Å–ø–∏—Å–æ–∫ –∫–æ–º–∞–Ω–¥ + —Å—Å—ã–ª–∫–∞ –Ω–∞ –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
        </div>
      </div>
    </div>

    <!-- System -->
    <div class="sec">‚öôÔ∏è –°–∏—Å—Ç–µ–º–∞</div>
    <div class="row2">
      <div class="fg">
        <label>–ò–º—è —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ (mDNS / OTA)</label>
        <input type="text" name="dn" placeholder="watersensor" maxlength="31">
        <p class="hint">–î–æ—Å—Ç—É–ø: <b>http://watersensor.local</b></p>
      </div>
      <div class="fg">
        <label>–ü–∞—Ä–æ–ª—å OTA-–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è</label>
        <input type="password" name="op" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" maxlength="31">
        <p class="hint">–î–ª—è ArduinoOTA –∏ –≤–µ–±-–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è (/update)</p>
      </div>
    </div>

    <!-- Save -->
    <div style="margin-top:24px;display:flex;gap:12px;flex-wrap:wrap">
      <button type="submit" class="btn btn-p" style="width:auto;padding:11px 32px">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å</button>
      <a href="/"><button type="button" class="btn btn-s" style="width:auto;padding:11px 24px">–û—Ç–º–µ–Ω–∞</button></a>
    </div>

  </form>
</div>

<div class="toast" id="toast"></div>
<script>
function showToast(m,t){
  var el=document.getElementById('toast');
  el.textContent=m; el.className='toast show '+(t||'');
  setTimeout(function(){el.className='toast';},3500);
}

function esc(s){
  return String(s).replace(/[&<>"]/g,function(c){
    return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'})[c];
  });
}

function setWifiScanBusy(busy){
  var btn=document.getElementById('scanWifiBtn');
  var list=document.getElementById('wifiList');
  btn.disabled=busy;
  list.disabled=busy;
  btn.textContent=busy?'–°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ...':'–°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å Wi-Fi';
}

function renderWifiList(items){
  var list=document.getElementById('wifiList');
  if(!items || !items.length){
    list.innerHTML='<option value="">–°–µ—Ç–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</option>';
    return;
  }
  list.innerHTML='<option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Å–µ—Ç—å...</option>'+items.map(function(n){
    var lock=n.enc?' üîí':'';
    var rssi=(typeof n.rssi==='number'?' ('+n.rssi+' dBm)':'');
    return '<option value="'+esc(n.ssid)+'">'+esc(n.ssid)+lock+rssi+'</option>';
  }).join('');
}

function scanWifi(){
  setWifiScanBusy(true);
  fetch('/api/wifi-scan')
    .then(function(r){return r.json();})
    .then(function(res){
      var seen={};
      var items=(res.networks||[])
        .filter(function(n){ return n && n.ssid; })
        .sort(function(a,b){ return (b.rssi||-999) - (a.rssi||-999); })
        .filter(function(n){
          if(seen[n.ssid]) return false;
          seen[n.ssid]=1;
          return true;
        });
      renderWifiList(items);
      if(items.length) showToast('–°–ø–∏—Å–æ–∫ Wi-Fi –æ–±–Ω–æ–≤–ª—ë–Ω','ok');
      else showToast('Wi-Fi —Å–µ—Ç–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã','err');
    })
    .catch(function(){
      showToast('–û—à–∏–±–∫–∞ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è Wi-Fi','err');
      renderWifiList([]);
    })
    .finally(function(){ setWifiScanBusy(false); });
}

// Toggle visibility
function vis(boxId,chk){document.getElementById(boxId).style.display=chk.checked?'block':'none';}
document.getElementById('tde').addEventListener('change',function(){vis('ds18Box',this);});
document.getElementById('tme').addEventListener('change',function(){vis('mqttBox',this);});
document.getElementById('tte').addEventListener('change',function(){vis('tgBox',this);});
document.getElementById('scanWifiBtn').addEventListener('click', scanWifi);
document.getElementById('wifiList').addEventListener('change', function(){
  if(this.value) document.getElementById('frm').elements['ws'].value=this.value;
});

// Load config
fetch('/api/config').then(function(r){return r.json();}).then(function(c){
  var f=document.getElementById('frm');
  Object.keys(c).forEach(function(k){
    var el=f.elements[k];
    if(!el) return;
    if(el.type==='checkbox') el.checked=!!c[k];
    else el.value=c[k]!==undefined&&c[k]!==null?c[k]:'';
  });
  vis('ds18Box',f.elements['de']);
  vis('mqttBox',f.elements['me']);
  vis('tgBox',f.elements['te']);
}).catch(function(){showToast('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫','err');});

// Save config
document.getElementById('frm').addEventListener('submit',function(e){
  e.preventDefault();
  var f=this, data={};
  Array.from(f.elements).forEach(function(el){
    if(!el.name) return;
    if(el.type==='checkbox') data[el.name]=el.checked;
    else if(el.type==='number') data[el.name]=el.value===''?null:parseFloat(el.value);
    else data[el.name]=el.value;
  });
  fetch('/api/config',{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify(data)
  }).then(function(r){return r.json();}).then(function(res){
    if(res.ok){
      showToast('–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã. –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞...','ok');
      setTimeout(function(){location.href='/';},4000);
    } else {
      showToast('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è','err');
    }
  }).catch(function(){showToast('–ù–µ—Ç —Å–≤—è–∑–∏ —Å —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ–º','err');});
});
</script>
</body>
</html>
